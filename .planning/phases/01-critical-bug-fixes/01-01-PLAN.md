---
phase: 01-critical-bug-fixes
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/components/admin/RichTextEditor.jsx
  - tests/components/rich-text-editor.test.jsx
autonomous: true

must_haves:
  truths:
    - "RichTextEditor renders without SSR crashes on all admin pages"
    - "TipTap editor initializes successfully in both dev and production builds"
    - "All 5 affected admin pages (about-us, blog create/edit, products create/edit) load without errors"
  artifacts:
    - path: "src/components/admin/RichTextEditor.jsx"
      provides: "TipTap editor component with immediatelyRender: false config"
    - path: "tests/components/rich-text-editor.test.jsx"
      provides: "Test coverage verifying SSR-safe rendering"
  key_links:
    - from: "src/components/admin/RichTextEditor.jsx"
      to: "src/app/(admin)/admin/about-us/page.jsx"
      via: "imported and used in about-us page"
    - from: "src/components/admin/RichTextEditor.jsx"
      to: "src/app/(admin)/admin/blog/create/page.jsx"
      via: "imported and used in blog create page"
    - from: "src/components/admin/RichTextEditor.jsx"
      to: "src/app/(admin)/admin/blog/edit/[id]/BlogEditClient.jsx"
      via: "imported and used in blog edit client"
    - from: "src/components/admin/RichTextEditor.jsx"
      to: "src/app/(admin)/admin/products/create/page.jsx"
      via: "imported and used in products create page"
    - from: "src/components/admin/RichTextEditor.jsx"
      to: "src/app/(admin)/admin/products/edit/[id]/ProductEditClient.jsx"
      via: "imported and used in products edit client"
---

<objective>
Fix TipTap SSR crash that prevents 5+ admin pages from loading.

Purpose: Unblock admin content management workflows by ensuring RichTextEditor component renders safely during server-side rendering in Next.js 16 App Router.

Output:
- RichTextEditor component with `immediatelyRender: false` option added to useEditor config
- Test coverage verifying SSR-safe initialization
- All 202+ existing tests still passing
- Production build succeeds without SSR errors
</objective>

<execution_context>
@C:/Users/commo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/commo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
@.planning/codebase/CONCERNS.md
@src/components/admin/RichTextEditor.jsx
@tests/components/rich-text-editor.test.jsx
</context>

<tasks>
<task type="auto">
  <name>Task 1: Write failing test reproducing TipTap SSR crash</name>
  <files>tests/components/rich-text-editor.test.jsx</files>
  <action>
    1. Read existing test file at `tests/components/rich-text-editor.test.jsx` to understand current test structure
    2. Add new test case at the end of the describe block:
       ```javascript
       it('renders without SSR crash when immediatelyRender is configured', () => {
         // This test will fail initially because immediatelyRender: false is missing
         const { container } = render(<RichTextEditor content="<p>Test content</p>" onChange={vi.fn()} />)

         // Verify editor wrapper exists (proves component mounted successfully)
         const editorWrapper = container.querySelector('[data-testid="editor-wrapper"]')
         expect(editorWrapper).toBeTruthy()

         // Verify editor content area exists (proves TipTap initialized)
         const proseMirror = container.querySelector('.ProseMirror')
         expect(proseMirror).toBeTruthy()
       })
       ```
    3. Run test to verify it FAILS with current implementation
    4. This establishes TDD RED phase baseline
  </action>
  <verify>npm test tests/components/rich-text-editor.test.jsx</verify>
  <done>Test file updated with new SSR crash test case that currently fails, establishing RED phase</done>
</task>

<task type="auto">
  <name>Task 2: Add immediatelyRender: false to RichTextEditor useEditor config</name>
  <files>src/components/admin/RichTextEditor.jsx</files>
  <action>
    1. Read current RichTextEditor implementation at `src/components/admin/RichTextEditor.jsx`
    2. Locate the `useEditor` hook call (line 169-179)
    3. Add `immediatelyRender: false` option to the config object:
       ```javascript
       const editor = useEditor({
         extensions: [
           StarterKit.configure({ link: false }),
           Image,
           Link.configure({ openOnClick: false }),
         ],
         content,
         onUpdate: ({ editor }) => {
           onChange?.(editor.getHTML())
         },
         immediatelyRender: false,  // ← Add this line
       })
       ```
    4. Ensure the change is on line 179, right after the `onUpdate` callback
    5. This defers TipTap rendering until client hydration, preventing SSR crashes
  </action>
  <verify>npm test tests/components/rich-text-editor.test.jsx</verify>
  <done>RichTextEditor.jsx updated with immediatelyRender: false option, test now passes (GREEN phase)</done>
</task>

<task type="auto">
  <name>Task 3: Verify all affected admin pages load without errors</name>
  <files>src/app/(admin)/admin/about-us/page.jsx, src/app/(admin)/admin/blog/create/page.jsx, src/app/(admin)/admin/blog/edit/[id]/BlogEditClient.jsx, src/app/(admin)/admin/products/create/page.jsx, src/app/(admin)/admin/products/edit/[id]/ProductEditClient.jsx</files>
  <action>
    1. Run full test suite to ensure no regressions:
       ```bash
       npm test
       ```
    2. Verify all 202+ tests pass (199 passing + 3 pre-existing validation failures)
    3. Run production build to verify SSR works correctly:
       ```bash
       npm run build
       ```
    4. Check build output for any SSR-related errors or warnings
    5. Verify the build completes successfully without TipTap initialization errors
    6. Document that the following pages are now fixed:
       - /admin/about-us (uses RichTextEditor for company description)
       - /admin/blog/create (uses RichTextEditor for blog content)
       - /admin/blog/edit/[id] (uses RichTextEditor for blog content)
       - /admin/products/create (uses RichTextEditor for product description)
       - /admin/products/edit/[id] (uses RichTextEditor for product description)
  </action>
  <verify>npm test && npm run build</verify>
  <done>All 202+ tests passing, production build succeeds, all 5 affected admin pages confirmed working</done>
</task>

<task type="auto">
  <name>Task 4: Add edge case test for editor with null/undefined content</name>
  <files>tests/components/rich-text-editor.test.jsx</files>
  <action>
    1. Add additional test case to prevent regressions with edge cases:
       ```javascript
       it('handles null/undefined content gracefully without SSR errors', () => {
         // Test with null content
         const { container: container1 } = render(<RichTextEditor content={null} onChange={vi.fn()} />)
         expect(container1.querySelector('.ProseMirror')).toBeTruthy()

         // Test with undefined content
         const { container: container2 } = render(<RichTextEditor onChange={vi.fn()} />)
         expect(container2.querySelector('.ProseMirror')).toBeTruthy()

         // Test with empty string
         const { container: container3 } = render(<RichTextEditor content="" onChange={vi.fn()} />)
         expect(container3.querySelector('.ProseMirror')).toBeTruthy()
       })
       ```
    2. Run tests to verify all cases pass
    3. This completes TDD REFACTOR phase with edge case coverage
  </action>
  <verify>npm test tests/components/rich-text-editor.test.jsx</verify>
  <done>Edge case tests added and passing, ensuring robust SSR handling for all content values</done>
</task>
</tasks>

<verification>
## Overall Checks

- [ ] Run `npm test` — all 202+ tests pass (199 passing + 3 pre-existing validation failures unchanged)
- [ ] Run `npm run build` — production build succeeds without SSR errors
- [ ] Navigate to `/admin/about-us` in dev mode — RichTextEditor loads without crash
- [ ] Navigate to `/admin/blog/create` in dev mode — RichTextEditor loads without crash
- [ ] Navigate to `/admin/products/create` in dev mode — RichTextEditor loads without crash
- [ ] Check browser console — no React hydration warnings or TipTap errors
- [ ] Verify toolbar buttons render and are clickable
- [ ] Verify editor content is editable after initial render
</verification>

<success_criteria>
## Measurable Completion

1. **Code Change**: `immediatelyRender: false` option added to useEditor config in RichTextEditor.jsx (line 179)
2. **Test Coverage**: New test case verifies SSR-safe rendering without crashes
3. **No Regressions**: All 202+ existing tests still pass
4. **Build Success**: `npm run build` completes without TipTap SSR errors
5. **Pages Fixed**: All 5 admin pages using RichTextEditor load successfully:
   - /admin/about-us ✓
   - /admin/blog/create ✓
   - /admin/blog/edit/[id] ✓
   - /admin/products/create ✓
   - /admin/products/edit/[id] ✓
6. **Observable Behavior**: Admin users can now create/edit blog posts, products, and about-us content without encountering ErrorBoundary crash screen
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-bug-fixes/01-01-SUMMARY.md` documenting:
- TDD cycle (RED → GREEN → REFACTOR)
- Exact line changed in RichTextEditor.jsx
- Test results showing all tests passing
- Build output confirming SSR success
- List of fixed admin pages
</output>
