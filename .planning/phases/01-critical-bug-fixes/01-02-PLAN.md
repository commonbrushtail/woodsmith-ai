---
phase: 01-critical-bug-fixes
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/app/(admin)/admin/banner/create/page.jsx
  - tests/lib/actions/banners.test.js
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to /admin/banner/create without 404 error"
    - "Banner create page renders form matching existing admin create page patterns"
    - "Admins can successfully create new banners via the create page"
  artifacts:
    - path: "src/app/(admin)/admin/banner/create/page.jsx"
      provides: "Banner create page following FAQ/blog create patterns"
    - path: "tests/lib/actions/banners.test.js"
      provides: "Test coverage for createBanner action validation"
  key_links:
    - from: "src/app/(admin)/admin/banner/create/page.jsx"
      to: "src/lib/actions/banners.js"
      via: "calls createBanner Server Action on form submit"
    - from: "src/components/admin/BannersListClient.jsx"
      to: "src/app/(admin)/admin/banner/create/page.jsx"
      via: "'Create new entry' button links to /admin/banner/create"
    - from: "src/app/(admin)/admin/banner/create/page.jsx"
      to: "src/app/(admin)/admin/faq/create/page.jsx"
      via: "follows same client-component create page pattern"
---

<objective>
Create missing banner create page to unblock admin banner management workflow.

Purpose: Fix 404 error on /admin/banner/create so admins can add new banners without database manipulation.

Output:
- New banner create page at `src/app/(admin)/admin/banner/create/page.jsx`
- Test coverage for createBanner action
- "Create new entry" link on banner list page now functional
- Banner creation workflow complete (list → create → edit)
</objective>

<execution_context>
@C:/Users/commo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/commo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
@.planning/codebase/ARCHITECTURE.md
@src/app/(admin)/admin/faq/create/page.jsx
@src/app/(admin)/admin/banner/page.jsx
@src/lib/actions/banners.js
@tests/lib/actions/banners.test.js
</context>

<tasks>
<task type="auto">
  <name>Task 1: Write failing test for banner create functionality</name>
  <files>tests/lib/actions/banners.test.js</files>
  <action>
    1. Check if test file exists at `tests/lib/actions/banners.test.js`
    2. If it doesn't exist, create it with standard Vitest structure and Supabase mock setup:
       ```javascript
       import { describe, it, expect, vi, beforeEach } from 'vitest'

       // Mock Supabase admin client
       let mockAdminQueryChain
       let mockAdmin

       vi.mock('@/lib/supabase/admin', () => ({
         createServiceClient: () => mockAdmin,
       }))

       // Mock next/cache
       const mockRevalidatePath = vi.fn()
       vi.mock('next/cache', () => ({
         revalidatePath: (...args) => mockRevalidatePath(...args),
       }))

       // Helper to create query chain
       function createQueryChain(finalResult = { data: null, error: null }) {
         const chain = {}
         const methods = ['select', 'insert', 'update', 'delete', 'eq', 'or', 'order', 'limit', 'single']
         for (const m of methods) {
           chain[m] = vi.fn(() => chain)
         }
         chain.then = (resolve) => resolve(finalResult)
         return chain
       }

       // Helper for FormData
       function fakeFormData(obj) {
         const map = new Map(Object.entries(obj))
         return {
           get: (key) => (map.has(key) ? map.get(key) : null),
           has: (key) => map.has(key),
           set: (key, val) => map.set(key, val),
         }
       }

       beforeEach(() => {
         vi.clearAllMocks()
         mockAdminQueryChain = createQueryChain()
         mockAdmin = { from: vi.fn(() => mockAdminQueryChain) }
       })
       ```
    3. Add test case for createBanner:
       ```javascript
       describe('createBanner', () => {
         it('creates banner with image_url and link_url', async () => {
           // Mock: existing banners query (for sort_order calculation)
           const existingChain = createQueryChain({ data: [{ sort_order: 2 }], error: null })
           mockAdmin.from = vi.fn((table) => {
             if (table === 'banners') {
               // First call is select for sort_order
               if (mockAdmin.from.mock.calls.length === 1) return existingChain
               // Second call is insert
               return createQueryChain({ data: { id: 'b1', sort_order: 3 }, error: null })
             }
             return mockAdminQueryChain
           })

           const { createBanner } = await import('@/lib/actions/banners')

           const formData = fakeFormData({
             image_url: 'https://cdn.woodsmith.test/banner.jpg',
             link_url: 'https://woodsmith.test/products',
             status: 'active',
           })

           const result = await createBanner(formData)

           expect(result.error).toBeNull()
           expect(result.data).toBeTruthy()
           expect(result.data.sort_order).toBe(3)
           expect(mockRevalidatePath).toHaveBeenCalledWith('/admin/banner')
         })
       })
       ```
    4. Run test to verify it FAILS (page doesn't exist yet, but action should work)
  </action>
  <verify>npm test tests/lib/actions/banners.test.js</verify>
  <done>Test file created with failing test case establishing TDD RED phase for banner creation workflow</done>
</task>

<task type="auto">
  <name>Task 2: Create banner create page following FAQ create pattern</name>
  <files>src/app/(admin)/admin/banner/create/page.jsx</files>
  <action>
    1. Create directory if needed: `src/app/(admin)/admin/banner/create/`
    2. Create new file `page.jsx` with the following structure based on FAQ create pattern:
       ```javascript
       'use client'

       import { useState, useTransition } from 'react'
       import { useRouter } from 'next/navigation'
       import { createBanner } from '@/lib/actions/banners'
       import { useToast } from '@/lib/toast-context'

       export default function BannerCreatePage() {
         const router = useRouter()
         const { toast } = useToast()
         const [isPending, startTransition] = useTransition()

         const [imageUrl, setImageUrl] = useState('')
         const [linkUrl, setLinkUrl] = useState('')
         const [status, setStatus] = useState('inactive')

         const handleSubmit = () => {
           startTransition(async () => {
             if (!imageUrl.trim()) {
               toast.error('กรุณากรอก URL ของรูปภาพ')
               return
             }

             const formData = new FormData()
             formData.set('image_url', imageUrl)
             formData.set('link_url', linkUrl)
             formData.set('status', status)

             const result = await createBanner(formData)

             if (result.error) {
               toast.error('เกิดข้อผิดพลาด: ' + result.error)
             } else {
               router.push('/admin/banner')
               router.refresh()
             }
           })
         }

         return (
           <div className={`flex flex-col gap-0 h-full min-h-0 ${isPending ? 'opacity-60 pointer-events-none' : ''}`}>
             {/* Header */}
             <div className="flex items-center justify-between py-[12px]">
               <div className="flex items-center gap-[12px]">
                 <h1 className="font-['IBM_Plex_Sans_Thai'] font-bold text-[22px] text-[#1f2937] m-0">
                   สร้างแบนเนอร์ใหม่
                 </h1>
                 <span className="inline-flex items-center px-[10px] py-[2px] rounded-full border border-[#ff7e1b]/40 bg-[#ff7e1b]/5 font-['IBM_Plex_Sans_Thai'] text-[12px] font-medium text-[#ff7e1b] leading-[1.8]">
                   ใหม่
                 </span>
               </div>
             </div>

             {/* Content */}
             <div className="flex gap-[24px] mt-[20px] flex-1 min-h-0 overflow-y-auto pb-[32px]">
               {/* Main form */}
               <div className="flex-1 flex flex-col gap-[24px] min-w-0">
                 <div className="bg-white rounded-[12px] border border-[#e8eaef] p-[20px] flex flex-col gap-[16px]">
                   {/* Image URL field */}
                   <div className="flex flex-col gap-[6px]">
                     <label className="font-['IBM_Plex_Sans_Thai'] text-[13px] font-medium text-[#374151]">
                       URL รูปภาพ <span className="text-red-500">*</span>
                     </label>
                     <input
                       type="text"
                       value={imageUrl}
                       onChange={(e) => setImageUrl(e.target.value)}
                       placeholder="https://cdn.woodsmith.test/banner.jpg"
                       className="w-full font-['IBM_Plex_Sans_Thai'] text-[14px] text-[#1f2937] border border-[#e8eaef] rounded-[8px] px-[14px] py-[10px] outline-none focus:border-[#ff7e1b] focus:ring-1 focus:ring-[#ff7e1b]/20 transition-all placeholder:text-[#bfbfbf]"
                     />
                   </div>

                   {/* Link URL field */}
                   <div className="flex flex-col gap-[6px]">
                     <label className="font-['IBM_Plex_Sans_Thai'] text-[13px] font-medium text-[#374151]">
                       URL ลิงก์ปลายทาง
                     </label>
                     <input
                       type="text"
                       value={linkUrl}
                       onChange={(e) => setLinkUrl(e.target.value)}
                       placeholder="https://woodsmith.test/products"
                       className="w-full font-['IBM_Plex_Sans_Thai'] text-[14px] text-[#1f2937] border border-[#e8eaef] rounded-[8px] px-[14px] py-[10px] outline-none focus:border-[#ff7e1b] focus:ring-1 focus:ring-[#ff7e1b]/20 transition-all placeholder:text-[#bfbfbf]"
                     />
                   </div>

                   {/* Status field */}
                   <div className="flex flex-col gap-[6px]">
                     <label className="font-['IBM_Plex_Sans_Thai'] text-[13px] font-medium text-[#374151]">
                       สถานะ
                     </label>
                     <select
                       value={status}
                       onChange={(e) => setStatus(e.target.value)}
                       className="w-full font-['IBM_Plex_Sans_Thai'] text-[14px] text-[#1f2937] border border-[#e8eaef] rounded-[8px] px-[14px] py-[10px] outline-none focus:border-[#ff7e1b] focus:ring-1 focus:ring-[#ff7e1b]/20 transition-all"
                     >
                       <option value="inactive">ไม่แสดง</option>
                       <option value="active">แสดง</option>
                     </select>
                   </div>
                 </div>
               </div>

               {/* Right sidebar */}
               <aside className="w-[260px] shrink-0 flex flex-col gap-[16px]">
                 <div className="bg-white rounded-[12px] border border-[#e8eaef] p-[20px] flex flex-col gap-[16px]">
                   <h3 className="font-['IBM_Plex_Sans_Thai'] font-semibold text-[12px] text-[#9ca3af] tracking-[0.8px] uppercase m-0">
                     การดำเนินการ
                   </h3>

                   <button
                     type="button"
                     onClick={handleSubmit}
                     disabled={isPending}
                     className="w-full flex items-center justify-center px-[16px] py-[8px] rounded-[8px] bg-[#ff7e1b] text-white font-['IBM_Plex_Sans_Thai'] font-medium text-[14px] border-0 cursor-pointer hover:bg-[#e56f15] transition-colors disabled:opacity-50"
                   >
                     {isPending ? 'กำลังบันทึก...' : 'สร้างแบนเนอร์'}
                   </button>
                 </div>
               </aside>
             </div>
           </div>
         )
       }
       ```
    3. This creates a simple form with:
       - Image URL field (required)
       - Link URL field (optional)
       - Status dropdown (active/inactive)
       - Submit button that calls createBanner action
    4. Pattern matches FAQ create page structure (client component, useTransition, toast notifications)
  </action>
  <verify>npm test tests/lib/actions/banners.test.js</verify>
  <done>Banner create page created at src/app/(admin)/admin/banner/create/page.jsx following admin create page patterns</done>
</task>

<task type="auto">
  <name>Task 3: Verify banner creation workflow end-to-end</name>
  <files>src/app/(admin)/admin/banner/create/page.jsx</files>
  <action>
    1. Run full test suite to ensure no regressions:
       ```bash
       npm test
       ```
    2. Verify createBanner test now passes
    3. Run production build to verify page compiles:
       ```bash
       npm run build
       ```
    4. Check that route /admin/banner/create exists in build output
    5. Verify no 404 errors for the banner create route
    6. Document the complete banner workflow:
       - List page: /admin/banner (shows existing banners)
       - Create page: /admin/banner/create (newly added)
       - Edit page: /admin/banner/edit/[id] (already exists)
    7. Verify "Create new entry" button in BannersListClient links to /admin/banner/create
  </action>
  <verify>npm test && npm run build</verify>
  <done>Banner create page route confirmed working, workflow complete, all tests passing</done>
</task>

<task type="auto">
  <name>Task 4: Add validation test for required image_url field</name>
  <files>tests/lib/actions/banners.test.js</files>
  <action>
    1. Add edge case test to verify validation:
       ```javascript
       it('handles missing image_url gracefully', async () => {
         const { createBanner } = await import('@/lib/actions/banners')

         const formData = fakeFormData({
           image_url: '',  // Empty image URL
           link_url: 'https://woodsmith.test/products',
           status: 'active',
         })

         const result = await createBanner(formData)

         // Should still create banner (validation happens on client)
         // This test verifies server action doesn't crash with empty image_url
         expect(result).toBeTruthy()
       })
       ```
    2. Run test to verify edge case handling
    3. This completes TDD REFACTOR phase with validation coverage
  </action>
  <verify>npm test tests/lib/actions/banners.test.js</verify>
  <done>Edge case test added for empty image_url validation, ensuring robust error handling</done>
</task>
</tasks>

<verification>
## Overall Checks

- [ ] Run `npm test` — all 202+ tests pass (including new banner create tests)
- [ ] Run `npm run build` — production build succeeds, /admin/banner/create route exists
- [ ] Navigate to `/admin/banner` in dev mode — "Create new entry" button visible
- [ ] Click "Create new entry" — redirects to `/admin/banner/create` without 404
- [ ] Fill banner form with image URL — form submits successfully
- [ ] After submit — redirects back to `/admin/banner` list page
- [ ] New banner appears in list — confirms creation workflow complete
- [ ] Check database — new banner record created with correct sort_order
</verification>

<success_criteria>
## Measurable Completion

1. **New File Created**: `src/app/(admin)/admin/banner/create/page.jsx` exists with 100+ lines of form code
2. **Test Coverage**: `tests/lib/actions/banners.test.js` has createBanner test cases
3. **No Regressions**: All 202+ existing tests still pass
4. **Build Success**: `npm run build` includes /admin/banner/create route
5. **Navigation Fixed**: Clicking "Create new entry" on banner list no longer returns 404
6. **Workflow Complete**: Banner CRUD workflow now matches other admin resources:
   - List: /admin/banner ✓
   - Create: /admin/banner/create ✓ (newly fixed)
   - Edit: /admin/banner/edit/[id] ✓
   - Delete: via list page action ✓
7. **Observable Behavior**: Admin users can now create new banners via CMS interface without database manipulation
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-bug-fixes/01-02-SUMMARY.md` documenting:
- TDD cycle (RED → GREEN → REFACTOR)
- New page.jsx file structure
- Test results showing banner create workflow tests passing
- Screenshots or descriptions of working create page
- Comparison to FAQ create page pattern (template used)
</output>
