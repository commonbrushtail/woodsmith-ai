---
phase: 03-hydration-warning-cleanup
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/components/admin/BannersListClient.jsx
  - src/components/admin/VideoHighlightsListClient.jsx
  - src/components/admin/GalleryListClient.jsx
  - src/components/admin/ManualsListClient.jsx
  - src/components/admin/FaqListClient.jsx
  - tests/components/banners-list-hydration.test.jsx
autonomous: true

must_haves:
  truths:
    - "All 5 sortable list pages render without React hydration warnings"
    - "Admin can drag-and-drop reorder items on all 5 list pages without console errors"
    - "All existing tests still pass after refactor (no regressions)"
  artifacts:
    - path: "tests/components/banners-list-hydration.test.jsx"
      provides: "TDD test that detects hydration warnings via console.error spy on BannersListClient"
  key_links:
    - from: "src/components/admin/BannersListClient.jsx"
      to: "@dnd-kit/core DndContext"
      via: "DndContext wraps entire table container div, NOT injected inside table/tbody"
    - from: "src/components/admin/VideoHighlightsListClient.jsx"
      to: "@dnd-kit/core DndContext"
      via: "Same DndContext-outside-table pattern as BannersListClient"
    - from: "src/components/admin/GalleryListClient.jsx"
      to: "@dnd-kit/core DndContext"
      via: "Same DndContext-outside-table pattern"
    - from: "src/components/admin/ManualsListClient.jsx"
      to: "@dnd-kit/core DndContext"
      via: "Same DndContext-outside-table pattern"
    - from: "src/components/admin/FaqListClient.jsx"
      to: "@dnd-kit/core DndContext"
      via: "Same DndContext-outside-table pattern"
---

<objective>
Move DndContext wrapper outside table elements in all 5 admin sortable list pages to eliminate React hydration warnings.

Purpose: Fix BUG-03 (dnd-kit hydration mismatch) — DndContext injects accessibility `<div>` elements inside `<table>`, violating HTML5 spec and causing React hydration errors.

Output:
- All 5 ListClient components refactored with DndContext outside table boundary
- TDD test verifying no hydration warnings
- All existing tests still passing
- Production build succeeds
</objective>

<execution_context>
@C:/Users/commo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/commo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/TESTING.md
@src/components/admin/BannersListClient.jsx
@src/components/admin/VideoHighlightsListClient.jsx
@src/components/admin/GalleryListClient.jsx
@src/components/admin/ManualsListClient.jsx
@src/components/admin/FaqListClient.jsx
</context>

<tasks>
<task type="auto">
  <name>Task 1: Write failing test that detects hydration warnings on BannersListClient</name>
  <files>tests/components/banners-list-hydration.test.jsx</files>
  <action>
Create a new test file that renders BannersListClient and checks for hydration warnings via console.error spy. This tests the ACTUAL affected component (not SortableList.jsx, which is a separate reusable component that no ListClient imports).

**IMPORTANT:** The 5 ListClient components each have their own INLINE DndContext/SortableContext code — they do NOT import SortableList.jsx. The fix must happen in each ListClient file directly.

Test spec:
```javascript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest'
import { render, screen } from '@testing-library/react'
import { createElement } from 'react'
import BannersListClient from '@/components/admin/BannersListClient'

// Mock dependencies
vi.mock('next/navigation', () => ({
  useRouter: () => ({ push: vi.fn(), refresh: vi.fn() }),
}))

vi.mock('@/lib/toast-context', () => ({
  useToast: () => ({ toast: { success: vi.fn(), error: vi.fn() } }),
}))

vi.mock('@/lib/actions/banners', () => ({
  deleteBanner: vi.fn(async () => ({ error: null })),
  toggleBannerStatus: vi.fn(async () => ({ error: null })),
  reorderBanners: vi.fn(async () => ({ error: null })),
}))

describe('BannersListClient - Hydration Safety', () => {
  let consoleErrorSpy

  beforeEach(() => {
    consoleErrorSpy = vi.spyOn(console, 'error').mockImplementation(() => {})
  })

  afterEach(() => {
    consoleErrorSpy.mockRestore()
  })

  it('renders without React hydration warnings or validateDOMNesting errors', () => {
    const mockBanners = [
      { id: '1', image_url: '/banner1.jpg', link_url: '', status: 'active', sort_order: 0, created_at: '2024-01-01T00:00:00Z' },
      { id: '2', image_url: '/banner2.jpg', link_url: '', status: 'inactive', sort_order: 1, created_at: '2024-01-02T00:00:00Z' },
    ]

    render(createElement(BannersListClient, { banners: mockBanners }))

    // CRITICAL: No hydration or DOM nesting warnings
    const hydrationWarnings = consoleErrorSpy.mock.calls.filter(call =>
      call.some(arg =>
        typeof arg === 'string' &&
        (arg.includes('Hydration') ||
         arg.includes('did not match') ||
         arg.includes('Warning: validateDOMNesting'))
      )
    )
    expect(hydrationWarnings).toHaveLength(0)
  })

  it('renders drag handles for sortable items', () => {
    const mockBanners = [
      { id: '1', image_url: '/banner1.jpg', link_url: '', status: 'active', sort_order: 0, created_at: '2024-01-01T00:00:00Z' },
    ]

    render(createElement(BannersListClient, { banners: mockBanners }))

    const dragHandles = screen.getAllByLabelText('ลากเพื่อจัดเรียง')
    expect(dragHandles).toHaveLength(1)
  })
})
```

**Expected result at this stage**: Test may FAIL due to DndContext injecting divs inside table, triggering validateDOMNesting warnings captured by the console.error spy. This is the TDD RED phase.
  </action>
  <verify>npm test -- banners-list-hydration.test.jsx</verify>
  <done>Test file created. If hydration warnings are detected, RED phase confirmed. If test passes, the jsdom environment may not trigger the warning (still proceed to fix — the bug manifests in real browsers).</done>
</task>

<task type="auto">
  <name>Task 2: Refactor all 5 ListClient components to move DndContext outside table</name>
  <files>
    src/components/admin/BannersListClient.jsx
    src/components/admin/VideoHighlightsListClient.jsx
    src/components/admin/GalleryListClient.jsx
    src/components/admin/ManualsListClient.jsx
    src/components/admin/FaqListClient.jsx
  </files>
  <action>
**Problem:** All 5 ListClient files currently embed DndContext INSIDE `<table><tbody>`, causing hydration errors. Each file has its own inline dnd-kit code (they do NOT import SortableList.jsx).

**Solution:** Move DndContext and SortableContext wrappers OUTSIDE the table structure in each file.

**Pattern to apply to all 5 files:**

CURRENT (causes hydration error):
```jsx
<div className="border border-[#e5e7eb] rounded-[...] overflow-hidden bg-white">
  <div className="overflow-x-auto">
    <table className="w-full border-collapse">
      <thead>...</thead>
      <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
        <SortableContext items={items.map(i => i.id)} strategy={verticalListSortingStrategy}>
          <tbody>
            {items.map(item => <SortableRow ...>...</SortableRow>)}
          </tbody>
        </SortableContext>
      </DndContext>
    </table>
  </div>
</div>
```

NEW (valid HTML, no hydration errors):
```jsx
<DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
  <SortableContext items={items.map(i => i.id)} strategy={verticalListSortingStrategy}>
    <div className="border border-[#e5e7eb] rounded-[...] overflow-hidden bg-white">
      <div className="overflow-x-auto">
        <table className="w-full border-collapse">
          <thead>...</thead>
          <tbody>
            {items.map(item => <SortableRow ...>...</SortableRow>)}
          </tbody>
        </table>
      </div>
    </div>
  </SortableContext>
</DndContext>
```

**Apply to each file — read the file first to find exact line numbers:**

1. **BannersListClient.jsx**: Find where DndContext/SortableContext are nested inside the table. Move them to wrap the entire table container div. Close them after the table container div closes.

2. **VideoHighlightsListClient.jsx**: Same pattern — find DndContext inside table, move outside.

3. **GalleryListClient.jsx**: Same pattern.

4. **ManualsListClient.jsx**: Same pattern.

5. **FaqListClient.jsx**: Same pattern.

**For each file:**
1. Read the file to find exact DndContext/SortableContext positions
2. Move the opening `<DndContext>` and `<SortableContext>` tags to BEFORE the table container div
3. Move the closing `</SortableContext>` and `</DndContext>` tags to AFTER the table container div closes
4. Remove the old DndContext/SortableContext tags from inside the table
5. Ensure indentation is correct after moving

**Critical:** Do NOT change the SortableRow components inside tbody — they stay as-is. Only the DndContext/SortableContext wrapper positions change.
  </action>
  <verify>npm test && npm run build</verify>
  <done>All 5 ListClient files refactored with DndContext outside table. Tests pass, build succeeds. TDD GREEN phase complete.</done>
</task>

<task type="auto">
  <name>Task 3: Verify hydration test passes and no regressions</name>
  <files>tests/components/banners-list-hydration.test.jsx</files>
  <action>
1. Run the hydration test specifically to confirm it passes after the refactor:
   ```bash
   npm test -- banners-list-hydration.test.jsx
   ```

2. Run full test suite to verify no regressions:
   ```bash
   npm test
   ```
   Expected: All 202+ tests pass (199 passing + 3 pre-existing validation failures unchanged)

3. Run production build:
   ```bash
   npm run build
   ```
   Expected: Build completes successfully without hydration errors in build output

4. If any tests fail, investigate and fix before proceeding. Common issues:
   - Import path changes (unlikely since only wrapper positions changed)
   - CSS class changes (shouldn't happen — same divs, just different nesting level for DndContext)
  </action>
  <verify>npm test && npm run build</verify>
  <done>Hydration test passes, all 202+ existing tests pass (no regressions), production build succeeds</done>
</task>
</tasks>

<verification>
## Final Checks

1. Run `npm test` — all tests pass (no new failures)
2. Run `npm run build` — production build succeeds
3. Manual browser checks (supplementary, not required for autonomous execution):
   - Navigate to `/admin/banner` → verify no console warnings, drag-drop works
   - Navigate to `/admin/video-highlight` → same checks
   - Navigate to `/admin/gallery` → same checks
   - Navigate to `/admin/manual` → same checks
   - Navigate to `/admin/faq` → same checks
   - Check mobile/desktop responsive layouts → verify drag handles visible

## Automated Verification
- `npm test -- banners-list-hydration.test.jsx` passes (hydration test green)
- `npm test` passes (no regressions)
- `npm run build` succeeds (SSR works correctly)
</verification>

<success_criteria>
## Measurable Completion

1. **Zero hydration warnings**: Console output is clean on all 5 sortable list pages
2. **Functional drag-drop**: Reordering still works correctly after refactor
3. **Passing tests**: Hydration test + all existing tests still pass
4. **Clean build**: `npm run build` succeeds without hydration errors
5. **BUG-03 resolved**: DndContext is outside table boundary in all 5 ListClient files
</success_criteria>

<output>
After completion, create `.planning/phases/03-hydration-warning-cleanup/03-01-SUMMARY.md` with:

- Files changed (5 ListClient components + 1 test file)
- Test results (hydration test passes, no regressions)
- The pattern applied (DndContext moved from inside table to outside table container)
- Build output confirming success
- Any issues encountered and resolutions
</output>
