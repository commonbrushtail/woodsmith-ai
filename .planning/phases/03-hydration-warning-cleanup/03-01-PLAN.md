---
phase: 03-hydration-warning-cleanup
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/components/admin/SortableList.jsx
  - src/components/admin/BannersListClient.jsx
  - src/components/admin/VideoHighlightsListClient.jsx
  - src/components/admin/GalleryListClient.jsx
  - src/components/admin/ManualsListClient.jsx
  - src/components/admin/FaqListClient.jsx
  - tests/components/sortable-list.test.jsx
autonomous: true

must_haves:
  truths:
    - "All 5 sortable list pages render without React hydration warnings"
    - "DndContext wrapper is outside table element boundary"
    - "Drag-and-drop functionality still works correctly after refactor"
  artifacts:
    - path: "src/components/admin/SortableList.jsx"
      provides: "Reusable dnd-kit wrapper that does NOT inject divs inside tables"
    - path: "tests/components/sortable-list.test.jsx"
      provides: "Test that detects hydration warnings via console.error spy"
  key_links:
    - from: "SortableList.jsx"
      to: "5 ListClient components"
      via: "All list clients will use the refactored SortableList wrapper"
---

<objective>
Refactor SortableList component to eliminate React hydration warnings caused by DndContext injecting accessibility divs inside table elements. All 5 admin sortable list pages must render cleanly without console errors.

Purpose: Fix BUG-03 (dnd-kit hydration mismatch) by moving DndContext outside table boundary
Output: Clean console output on all 5 list pages + passing tests
</objective>

<execution_context>
@C:/Users/commo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/commo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/TESTING.md
@src/components/admin/SortableList.jsx
@src/components/admin/BannersListClient.jsx
@src/components/admin/VideoHighlightsListClient.jsx
@src/components/admin/GalleryListClient.jsx
@src/components/admin/ManualsListClient.jsx
@src/components/admin/FaqListClient.jsx
</context>

<tasks>
<task type="auto">
  <name>Task 1: Write failing test that detects hydration warnings</name>
  <files>tests/components/sortable-list.test.jsx</files>
  <action>
Create new test file `tests/components/sortable-list.test.jsx` following TDD red-green-refactor methodology.

Test spec:
```javascript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest'
import { render, screen } from '@testing-library/react'
import { createElement } from 'react'
import SortableList from '@/components/admin/SortableList'

describe('SortableList', () => {
  let consoleErrorSpy

  beforeEach(() => {
    consoleErrorSpy = vi.spyOn(console, 'error').mockImplementation(() => {})
  })

  afterEach(() => {
    consoleErrorSpy.mockRestore()
  })

  it('renders sortable items without hydration warnings', () => {
    const mockItems = [
      { id: '1', name: 'Item 1' },
      { id: '2', name: 'Item 2' },
      { id: '3', name: 'Item 3' },
    ]

    const mockOnReorder = vi.fn()

    render(
      createElement(SortableList, {
        items: mockItems,
        onReorder: mockOnReorder,
        children: (item) => createElement('div', { key: item.id }, item.name)
      })
    )

    // Check items rendered
    expect(screen.getByText('Item 1')).toBeInTheDocument()
    expect(screen.getByText('Item 2')).toBeInTheDocument()
    expect(screen.getByText('Item 3')).toBeInTheDocument()

    // CRITICAL: No React hydration warnings
    const hydrationWarnings = consoleErrorSpy.mock.calls.filter(call =>
      call.some(arg =>
        typeof arg === 'string' &&
        (arg.includes('Hydration') || arg.includes('did not match'))
      )
    )
    expect(hydrationWarnings).toHaveLength(0)
  })

  it('calls onReorder when drag completes', async () => {
    const mockItems = [
      { id: '1', name: 'Item 1' },
      { id: '2', name: 'Item 2' },
    ]
    const mockOnReorder = vi.fn()

    render(
      createElement(SortableList, {
        items: mockItems,
        onReorder: mockOnReorder,
        children: (item) => createElement('div', null, item.name)
      })
    )

    // Verify component renders (drag simulation requires complex setup, defer to E2E)
    expect(screen.getByTestId('sortable-item-1')).toBeInTheDocument()
    expect(screen.getByTestId('sortable-item-2')).toBeInTheDocument()
  })
})
```

**Expected result at this stage**: Test FAILS because current SortableList implementation causes hydration warnings (DndContext injects divs, violating HTML table spec).
  </action>
  <verify>npm test -- sortable-list.test.jsx</verify>
  <done>Test file exists and fails with hydration warning detected</done>
</task>

<task type="auto">
  <name>Task 2: Refactor SortableList to move DndContext outside table boundary</name>
  <files>src/components/admin/SortableList.jsx</files>
  <action>
**Analysis of current implementation:**

Current `SortableList.jsx` (lines 101-119) renders:
```jsx
<DndContext ...>
  <SortableContext ...>
    {items.map((item) => (
      <SortableItem key={item.id} id={item.id}>
        {children(item)}
      </SortableItem>
    ))}
  </SortableContext>
</DndContext>
```

**Problem:** When used inside a table, the 5 ListClient components insert this between `<tbody>` tags, causing DndContext to inject `<div>` elements (for accessibility announcements) inside `<table>`, which violates HTML5 spec and causes React hydration errors.

**Solution:** SortableList is currently a generic wrapper that returns only the sortable items. It CANNOT control the table structure. The fix must happen at the ListClient level by moving DndContext wrapper OUTSIDE the table.

**NEW APPROACH - Refactor SortableList.jsx:**

Replace current implementation with a table-compatible structure that wraps DndContext OUTSIDE:

```javascript
'use client'

import { useState } from 'react'
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
} from '@dnd-kit/core'
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  useSortable,
  verticalListSortingStrategy,
} from '@dnd-kit/sortable'
import { CSS } from '@dnd-kit/utilities'

function GripIcon() {
  return (
    <svg width="16" height="16" viewBox="0 0 16 16" fill="#9ca3af" xmlns="http://www.w3.org/2000/svg">
      <circle cx="6" cy="4" r="1.5" />
      <circle cx="10" cy="4" r="1.5" />
      <circle cx="6" cy="8" r="1.5" />
      <circle cx="10" cy="8" r="1.5" />
      <circle cx="6" cy="12" r="1.5" />
      <circle cx="10" cy="12" r="1.5" />
    </svg>
  )
}

function SortableItem({ id, children }) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id })

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    position: 'relative',
    zIndex: isDragging ? 10 : 'auto',
  }

  return (
    <div
      ref={setNodeRef}
      style={style}
      data-testid={`sortable-item-${id}`}
      className="flex items-center"
    >
      <button
        type="button"
        className="flex items-center justify-center size-[32px] cursor-grab active:cursor-grabbing rounded-[4px] hover:bg-[#f3f4f6] border-0 bg-transparent shrink-0 touch-none"
        aria-label="ลากเพื่อจัดเรียง"
        {...attributes}
        {...listeners}
      >
        <GripIcon />
      </button>
      <div className="flex-1 min-w-0">{children}</div>
    </div>
  )
}

/**
 * Sortable list wrapper using @dnd-kit.
 *
 * IMPORTANT: This component wraps DndContext OUTSIDE the children,
 * making it safe to use with table structures. Do NOT nest tables
 * inside DndContext - this component handles the wrapper.
 *
 * @param {Object} props
 * @param {Array<{id: string}>} props.items - Items to render (must have `id`)
 * @param {Function} props.onReorder - Called with new items array after drag
 * @param {Function} props.children - Render function: (item) => JSX
 */
export default function SortableList({ items, onReorder, children }) {
  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: { distance: 5 },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  )

  const handleDragEnd = (event) => {
    const { active, over } = event
    if (!over || active.id === over.id) return

    const oldIndex = items.findIndex((item) => item.id === active.id)
    const newIndex = items.findIndex((item) => item.id === over.id)
    const newItems = arrayMove(items, oldIndex, newIndex)
    onReorder(newItems)
  }

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={closestCenter}
      onDragEnd={handleDragEnd}
    >
      <SortableContext
        items={items.map((item) => item.id)}
        strategy={verticalListSortingStrategy}
      >
        {items.map((item) => (
          <SortableItem key={item.id} id={item.id}>
            {children(item)}
          </SortableItem>
        ))}
      </SortableContext>
    </DndContext>
  )
}
```

**Key changes:**
- Component is unchanged structurally BUT documented to clarify it wraps DndContext outside children
- ListClient files need to be refactored to NOT embed this inside tables
- This is a documentation-only change; real fix happens in next task
  </action>
  <verify>npm test -- sortable-list.test.jsx</verify>
  <done>Test passes - no hydration warnings detected</done>
</task>

<task type="auto">
  <name>Task 3: Refactor all 5 ListClient components to use non-table structure</name>
  <files>
    src/components/admin/BannersListClient.jsx
    src/components/admin/VideoHighlightsListClient.jsx
    src/components/admin/GalleryListClient.jsx
    src/components/admin/ManualsListClient.jsx
    src/components/admin/FaqListClient.jsx
  </files>
  <action>
**Problem:** All 5 ListClient files currently embed DndContext INSIDE `<table><tbody>`, causing hydration errors.

**Solution:** Move DndContext wrapper OUTSIDE the table structure. Each file has inline dnd-kit code that needs restructuring.

**Pattern to apply to all 5 files:**

CURRENT (causes hydration error):
```jsx
<table>
  <thead>...</thead>
  <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
    <SortableContext items={items.map(i => i.id)} strategy={verticalListSortingStrategy}>
      <tbody>
        {items.map(item => <SortableRow key={item.id} id={item.id}>...</SortableRow>)}
      </tbody>
    </SortableContext>
  </DndContext>
</table>
```

NEW (valid HTML, no hydration):
```jsx
<DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
  <SortableContext items={items.map(i => i.id)} strategy={verticalListSortingStrategy}>
    <div className="border border-[#e5e7eb] rounded-[12px] overflow-hidden bg-white">
      <div className="overflow-x-auto">
        <table className="w-full border-collapse">
          <thead>...</thead>
          <tbody>
            {items.map(item => <SortableRow key={item.id} id={item.id}>...</SortableRow>)}
          </tbody>
        </table>
      </div>
    </div>
  </SortableContext>
</DndContext>
```

**Apply to each file:**

1. **BannersListClient.jsx** (lines 224-364):
   - Move `<DndContext>` wrapper from line 264 to BEFORE the table container div at line 225
   - Move `<SortableContext>` from line 265 to wrap the table (after DndContext, before table)
   - Keep `<tbody>` at line 266 but REMOVE DndContext/SortableContext from inside table
   - Result: DndContext wraps entire table container, not injected between thead/tbody

2. **VideoHighlightsListClient.jsx** (lines 316-443):
   - Move `<DndContext>` from line 365 to BEFORE table container at line 317
   - Move `<SortableContext>` from line 366 to wrap table
   - Keep tbody structure intact

3. **GalleryListClient.jsx** (lines 314-446):
   - Move `<DndContext>` from line 363 to BEFORE table container at line 315
   - Move `<SortableContext>` from line 364 to wrap table
   - Keep tbody structure intact

4. **ManualsListClient.jsx** (lines 305-423):
   - Move `<DndContext>` from line 347 to BEFORE table container at line 306
   - Move `<SortableContext>` from line 348 to wrap table
   - Keep tbody structure intact

5. **FaqListClient.jsx** (lines 159-251):
   - Move `<DndContext>` from line 171 to BEFORE table container at line 160
   - Move `<SortableContext>` from line 172 to wrap table
   - Keep tbody structure intact

**Detailed refactor for BannersListClient.jsx (example for all 5):**

BEFORE (lines 224-264):
```jsx
      {/* Table */}
      <div className="border border-[#e5e7eb] rounded-[12px] overflow-hidden bg-white">
        <div className="overflow-x-auto">
          <table className="w-full border-collapse">
            <thead>
              <tr className="border-b border-[#e5e7eb] bg-[#f9fafb]">
                {/* header cells */}
              </tr>
            </thead>
            <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
              <SortableContext items={sortedBanners.map((b) => b.id)} strategy={verticalListSortingStrategy}>
                <tbody>
```

AFTER:
```jsx
      {/* Table */}
      <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
        <SortableContext items={sortedBanners.map((b) => b.id)} strategy={verticalListSortingStrategy}>
          <div className="border border-[#e5e7eb] rounded-[12px] overflow-hidden bg-white">
            <div className="overflow-x-auto">
              <table className="w-full border-collapse">
                <thead>
                  <tr className="border-b border-[#e5e7eb] bg-[#f9fafb]">
                    {/* header cells */}
                  </tr>
                </thead>
                <tbody>
```

And close the wrappers AFTER the table:
```jsx
                </tbody>
              </table>
            </div>
          </div>
        </SortableContext>
      </DndContext>
```

**Apply this same pattern to all 5 ListClient files.**
  </action>
  <verify>
npm run dev
# Navigate to each admin page and verify:
# 1. /admin/banner - no console warnings
# 2. /admin/video-highlight - no console warnings
# 3. /admin/gallery - no console warnings
# 4. /admin/manual - no console warnings
# 5. /admin/faq - no console warnings
# 6. Drag-and-drop still works on all pages
  </verify>
  <done>All 5 list pages render without hydration warnings AND drag-drop works</done>
</task>

<task type="auto">
  <name>Task 4: Run all existing tests to verify no regressions</name>
  <files>N/A - verification only</files>
  <action>
Run full test suite to ensure refactoring did not break existing functionality.

```bash
npm test
```

Expected: All 202+ tests pass (or same pre-existing failures as before: 199 pass, 3 validation failures).

If any NEW failures appear, investigate and fix before proceeding.
  </action>
  <verify>npm test</verify>
  <done>Test suite passes with no new failures (199 pass, 3 pre-existing)</done>
</task>

<task type="auto">
  <name>Task 5: Verify production build succeeds</name>
  <files>N/A - build verification</files>
  <action>
Run production build to ensure no SSR/build-time errors introduced by refactor.

```bash
npm run build
```

Expected: Build completes successfully with no hydration errors in build output.
  </action>
  <verify>npm run build</verify>
  <done>Production build succeeds with no errors</done>
</task>
</tasks>

<verification>
## Final Checks

1. ✅ All 5 sortable list pages load without React hydration warnings
2. ✅ Drag-and-drop reordering still works correctly on all 5 pages
3. ✅ Console is clean (no hydration mismatch errors)
4. ✅ Test suite passes (199 tests, 3 pre-existing failures)
5. ✅ Production build succeeds
6. ✅ Visual layout unchanged (responsive design intact)

## Manual Testing Checklist

- [ ] Navigate to `/admin/banner` → drag banner item → verify order updates
- [ ] Navigate to `/admin/video-highlight` → drag highlight → verify order updates
- [ ] Navigate to `/admin/gallery` → drag gallery item → verify order updates
- [ ] Navigate to `/admin/manual` → drag manual → verify order updates
- [ ] Navigate to `/admin/faq` → drag FAQ → verify order updates
- [ ] Open Chrome DevTools console on each page → verify zero errors
- [ ] Check mobile/desktop responsive layouts → verify drag handles visible
</verification>

<success_criteria>
## Measurable Completion

1. **Zero hydration warnings**: Console output is clean on all 5 sortable list pages
2. **Functional drag-drop**: Reordering works correctly after refactor
3. **Passing tests**: New SortableList test passes + all existing tests still pass
4. **Clean build**: `npm run build` succeeds without hydration errors
5. **BUG-03 resolved**: Requirement BUG-03 marked complete in REQUIREMENTS.md
</success_criteria>

<output>
After completion, create `.planning/phases/03-hydration-warning-cleanup/03-01-SUMMARY.md` with:

- Files changed (6 ListClient components + 1 test file)
- Test results (hydration warning test passes)
- Manual verification screenshots (console showing no errors)
- Performance notes (drag-drop latency unchanged)
- Any issues encountered and resolutions
</output>
