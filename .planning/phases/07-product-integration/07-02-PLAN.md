---
phase: 07-product-integration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/(admin)/admin/products/create/page.jsx
  - src/app/(admin)/admin/products/create/ProductCreateClient.jsx
  - src/app/(admin)/admin/products/edit/[id]/page.jsx
  - src/app/(admin)/admin/products/edit/[id]/ProductEditClient.jsx
autonomous: true

must_haves:
  truths:
    - "Admin can select variation groups when creating a product and chosen links are saved to database on submit"
    - "Admin can select variation groups when editing a product and see previously linked groups pre-selected"
    - "Admin can choose specific entries from each linked group via checkboxes"
    - "Admin can unlink a variation group by clicking its remove button"
    - "Admin can add ad-hoc variation entries on-the-fly during product create/edit"
    - "Editing a variation group's entries in the variations admin reflects automatically on linked products (inherent by junction table design)"
  artifacts:
    - path: "src/app/(admin)/admin/products/create/page.jsx"
      provides: "Server component fetching categories AND variation groups for create form"
      contains: "getVariationGroups"
    - path: "src/app/(admin)/admin/products/create/ProductCreateClient.jsx"
      provides: "Product create form with VariationLinker section"
      contains: "VariationLinker"
    - path: "src/app/(admin)/admin/products/edit/[id]/page.jsx"
      provides: "Server component fetching product with variation links AND all groups for edit form"
      contains: "getVariationGroups"
    - path: "src/app/(admin)/admin/products/edit/[id]/ProductEditClient.jsx"
      provides: "Product edit form with VariationLinker section showing existing links"
      contains: "VariationLinker"
  key_links:
    - from: "src/app/(admin)/admin/products/create/ProductCreateClient.jsx"
      to: "src/lib/actions/products.js"
      via: "calls syncProductVariationLinks after createProduct"
      pattern: "syncProductVariationLinks"
    - from: "src/app/(admin)/admin/products/edit/[id]/ProductEditClient.jsx"
      to: "src/lib/actions/products.js"
      via: "calls syncProductVariationLinks after updateProduct"
      pattern: "syncProductVariationLinks"
    - from: "src/app/(admin)/admin/products/create/page.jsx"
      to: "src/lib/actions/variations.js"
      via: "fetches variation groups for VariationLinker"
      pattern: "getVariationGroups"
---

<objective>
Integrate the VariationLinker component into the existing product create and edit forms, wiring it to sync product-variation links on save.

Purpose: Complete the product integration feature so admins can link variations to products during create/edit workflows.
Output: Modified product create/edit pages with functional variation linking.
</objective>

<execution_context>
@C:/Users/commo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/commo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-product-integration/07-01-SUMMARY.md
@src/app/(admin)/admin/products/create/page.jsx
@src/app/(admin)/admin/products/create/ProductCreateClient.jsx
@src/app/(admin)/admin/products/edit/[id]/page.jsx
@src/app/(admin)/admin/products/edit/[id]/ProductEditClient.jsx
@src/lib/actions/products.js
@src/lib/actions/variations.js
@src/components/admin/VariationLinker.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate VariationLinker into product create flow</name>
  <files>
    src/app/(admin)/admin/products/create/page.jsx
    src/app/(admin)/admin/products/create/ProductCreateClient.jsx
  </files>
  <action>
**Modify `src/app/(admin)/admin/products/create/page.jsx`:**

Import `getVariationGroups` from `@/lib/actions/variations`. Fetch variation groups in parallel with categories:

```jsx
import { getCategories } from '@/lib/actions/categories'
import { getVariationGroups } from '@/lib/actions/variations'
import ProductCreateClient from './ProductCreateClient'

export default async function ProductCreatePage() {
  const [{ data: categories }, { data: variationGroups }] = await Promise.all([
    getCategories(),
    getVariationGroups(),
  ])

  return <ProductCreateClient categories={categories || []} variationGroups={variationGroups || []} />
}
```

**Modify `src/app/(admin)/admin/products/create/ProductCreateClient.jsx`:**

1. Add `variationGroups` to the component props: `function ProductCreateClient({ categories = [], variationGroups = [] })`

2. Import the VariationLinker component:
   ```jsx
   import VariationLinker from '@/components/admin/VariationLinker'
   ```

3. Import the sync action:
   ```jsx
   import { createProduct, uploadProductImage, uploadOptionImage, updateProduct, syncProductVariationLinks } from '@/lib/actions/products'
   ```
   (Add `syncProductVariationLinks` to the existing import)

4. Add state for variation links:
   ```jsx
   const [variationLinks, setVariationLinks] = useState([])
   ```

5. Add the VariationLinker component in the form, placed AFTER the OptionsAccordion section (comment "8. Product Options") and BEFORE the "9. รายละเอียดสินค้า" section. This keeps variations separate from legacy product_options:

   ```jsx
   {/* 8.5 Variations */}
   <VariationLinker
     allGroups={variationGroups}
     initialLinks={[]}
     onChange={setVariationLinks}
   />
   ```

6. In the `handleSubmit` function, AFTER the product is created and images are uploaded (after the option image upload block, before `router.push`), add the variation link sync:

   ```jsx
   // Sync variation links
   if (variationLinks.length > 0 && newId) {
     const linkResult = await syncProductVariationLinks(newId, variationLinks)
     if (linkResult.error) {
       toast.error('เกิดข้อผิดพลาดในการเชื่อมโยงตัวเลือก')
     }
   }
   ```

   Place this block right before the `router.push('/admin/products')` call.

IMPORTANT: Do NOT remove or modify any existing functionality. Keep all existing imports, state, handlers, and UI sections intact. Only ADD the new imports, state, component, and submit logic.
  </action>
  <verify>Run `npm run build` to verify no errors. Grep ProductCreateClient.jsx for "VariationLinker" to confirm component is rendered. Grep for "syncProductVariationLinks" to confirm sync is called on submit. Grep page.jsx for "getVariationGroups" to confirm server-side fetch.</verify>
  <done>Product create page fetches variation groups server-side, renders VariationLinker in the form, and syncs selected variation links to database after product creation. All existing product create functionality preserved. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate VariationLinker into product edit flow</name>
  <files>
    src/app/(admin)/admin/products/edit/[id]/page.jsx
    src/app/(admin)/admin/products/edit/[id]/ProductEditClient.jsx
  </files>
  <action>
**Modify `src/app/(admin)/admin/products/edit/[id]/page.jsx`:**

Import `getVariationGroups` from `@/lib/actions/variations`. Fetch variation groups in parallel with product and categories:

```jsx
import { notFound } from 'next/navigation'
import { getProduct } from '@/lib/actions/products'
import { getCategories } from '@/lib/actions/categories'
import { getVariationGroups } from '@/lib/actions/variations'
import ProductEditClient from './ProductEditClient'

export default async function ProductEditPage({ params }) {
  const { id } = await params

  const [{ data: product, error }, { data: categories }, { data: variationGroups }] = await Promise.all([
    getProduct(id),
    getCategories(),
    getVariationGroups(),
  ])

  if (error || !product) {
    notFound()
  }

  return <ProductEditClient product={product} categories={categories || []} variationGroups={variationGroups || []} />
}
```

**Modify `src/app/(admin)/admin/products/edit/[id]/ProductEditClient.jsx`:**

1. Add `variationGroups` to the component props: `function ProductEditClient({ product, categories = [], variationGroups = [] })`

2. Import the VariationLinker component:
   ```jsx
   import VariationLinker from '@/components/admin/VariationLinker'
   ```

3. Import the sync action (add to existing import):
   ```jsx
   import { updateProduct, uploadOptionImage, syncProductVariationLinks } from '@/lib/actions/products'
   ```

4. Add state for variation links, initialized from existing product links:
   ```jsx
   const [variationLinks, setVariationLinks] = useState(() => {
     const links = product.product_variation_links || []
     return links.map(link => ({ group_id: link.group_id, entry_id: link.entry_id }))
   })
   ```

5. Add the VariationLinker component in the form, placed AFTER the OptionsAccordion section and BEFORE the "9. รายละเอียดสินค้า" section:

   ```jsx
   {/* 8.5 Variations */}
   <VariationLinker
     allGroups={variationGroups}
     initialLinks={product.product_variation_links || []}
     onChange={setVariationLinks}
   />
   ```

6. In the `handleSubmit` function, AFTER `updateProduct` succeeds and BEFORE `router.push`, add the variation link sync:

   ```jsx
   // Sync variation links
   const linkResult = await syncProductVariationLinks(product.id, variationLinks)
   if (linkResult.error) {
     toast.error('เกิดข้อผิดพลาดในการเชื่อมโยงตัวเลือก')
   }
   ```

   This should go after the updateProduct success check (after the `if (result.error)` block) and before `router.push('/admin/products')`. Always sync links on edit save, even if links array is empty (this handles unlinking all groups).

IMPORTANT: Do NOT remove or modify any existing functionality. Keep all existing imports, state, handlers, and UI sections intact. Only ADD the new imports, state, component, and submit logic.
  </action>
  <verify>Run `npm run build` to verify no errors. Grep ProductEditClient.jsx for "VariationLinker" to confirm component is rendered. Grep for "syncProductVariationLinks" to confirm sync on submit. Grep for "product_variation_links" to confirm initial links are passed. Grep page.jsx for "getVariationGroups" to confirm server-side fetch.</verify>
  <done>Product edit page fetches variation groups server-side, renders VariationLinker with existing links pre-selected, and syncs updated variation links on save. Unlinking all groups results in empty links array synced to database. All existing product edit functionality preserved. Build passes.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. Product create server page fetches variation groups via getVariationGroups
3. Product create client renders VariationLinker and syncs links after createProduct
4. Product edit server page fetches variation groups via getVariationGroups
5. Product edit client renders VariationLinker with existing links and syncs on save
6. Existing product create/edit functionality (images, options, rich text, etc.) unchanged
7. VariationLinker appears after OptionsAccordion and before rich text editors in form layout
</verification>

<success_criteria>
- Admin can select variation groups and pick entries when creating a product — links saved to product_variation_links table
- Admin can see previously linked variation groups pre-selected when editing a product
- Admin can unlink groups and deselect entries — changes saved on form submit
- Admin can add ad-hoc entries on-the-fly — entries persisted and auto-selected
- All existing product form functionality (images, options, dates, rich text) works unchanged
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-product-integration/07-02-SUMMARY.md`
</output>
