---
phase: 07-product-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/actions/products.js
  - src/components/admin/VariationLinker.jsx
autonomous: true

must_haves:
  truths:
    - "Server actions exist to sync product-variation links (bulk replace)"
    - "Server actions exist to create ad-hoc variation entries on-the-fly"
    - "getProduct returns existing variation links with group and entry details"
    - "VariationLinker component renders searchable group selector, entry checkboxes, and ad-hoc entry input"
    - "VariationLinker lets admin unlink a group by removing it from selection"
  artifacts:
    - path: "src/lib/actions/products.js"
      provides: "syncProductVariationLinks action + getProduct with variation link fetching"
      exports: ["syncProductVariationLinks"]
    - path: "src/components/admin/VariationLinker.jsx"
      provides: "Reusable variation linking UI component for product forms"
      exports: ["default"]
  key_links:
    - from: "src/components/admin/VariationLinker.jsx"
      to: "src/lib/actions/variations.js"
      via: "imports getVariationGroups, createVariationEntry"
      pattern: "import.*getVariationGroups.*from.*actions/variations"
    - from: "src/lib/actions/products.js"
      to: "product_variation_links table"
      via: "Supabase delete + insert for bulk sync"
      pattern: "product_variation_links"
---

<objective>
Create the server action for syncing product-variation links and a reusable VariationLinker UI component that handles group selection, entry picking, unlinking, and ad-hoc entry creation.

Purpose: Build the data layer and shared UI component that Plan 02 will integrate into the existing product create/edit forms.
Output: `syncProductVariationLinks` action in products.js + `VariationLinker.jsx` component
</objective>

<execution_context>
@C:/Users/commo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/commo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/actions/products.js
@src/lib/actions/variations.js
@src/components/admin/OptionsAccordion.jsx
@supabase/migrations/013_variation_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add syncProductVariationLinks action and extend getProduct to fetch variation links</name>
  <files>src/lib/actions/products.js</files>
  <action>
Modify `src/lib/actions/products.js` to add variation link support. Two changes:

**1. Extend `getProduct` to fetch variation links:**

Update the select query in `getProduct` to also join `product_variation_links` with their group and entry details. Change the `.select()` to:

```
*, product_images(id, url, is_primary, sort_order), product_options(id, option_type, label, image_url, sort_order), product_variation_links(id, group_id, entry_id, variation_groups(id, name), variation_entries(id, label, image_url, sort_order))
```

This way `product.product_variation_links` will contain an array of link objects, each with nested `variation_groups` and `variation_entries`.

**2. Add `syncProductVariationLinks` server action:**

Create a new exported async function `syncProductVariationLinks(productId, links)` where `links` is an array of `{ group_id, entry_id }` objects. This action:

- Uses `createServiceClient()` (same pattern as other admin mutations)
- Deletes ALL existing links for the product: `supabase.from('product_variation_links').delete().eq('product_id', productId)`
- If `links` array is non-empty, inserts new rows: each row is `{ product_id: productId, group_id: link.group_id, entry_id: link.entry_id }`
- Calls `revalidatePath('/admin/products')` and `revalidatePath('/admin/products/edit/' + productId)`
- Gets current user via `createClient()` + `auth.getUser()` and calls `logAudit({ userId: user?.id, action: 'product.sync_variation_links', targetId: productId })`
- Returns `{ error: null }` on success, `{ error: message }` on failure
- Does NOT need Zod validation (UUIDs come from internal state, not user text input)

Add the import for `createClient` if not already imported (it already is).
  </action>
  <verify>Run `npm run build` to verify no import errors or syntax issues. Grep for `syncProductVariationLinks` in products.js to confirm export exists. Grep for `product_variation_links` in the getProduct select to confirm join is added.</verify>
  <done>getProduct returns product_variation_links with nested variation_groups and variation_entries data. syncProductVariationLinks action bulk-replaces links for a product. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create VariationLinker component for product forms</name>
  <files>src/components/admin/VariationLinker.jsx</files>
  <action>
Create `src/components/admin/VariationLinker.jsx` — a 'use client' component that provides the full variation linking UI for product create/edit forms. This component manages its OWN local state (selected groups and entries) and exposes the current selection via a callback prop.

**Props:**
- `allGroups` — array of variation group objects (with `variation_entries` nested), fetched by parent server component and passed down
- `initialLinks` — array of existing `product_variation_links` from the product (for edit mode; empty array for create mode). Each link has `{ group_id, entry_id, variation_groups: { id, name }, variation_entries: { id, label, image_url, sort_order } }`
- `onChange(links)` — callback receiving current links array as `[{ group_id, entry_id }]` whenever selection changes. Parent form accumulates this and sends on submit.

**Component state:**
- `linkedGroups` — array of group IDs currently linked to the product
- `selectedEntries` — Map/object of `{ [groupId]: Set<entryId> }` tracking which entries are checked per group
- `expandedGroups` — Set of group IDs whose entry panel is expanded
- `searchQuery` — string for filtering the group dropdown

**Initialize state from `initialLinks` prop:**
- Extract unique group IDs into `linkedGroups`
- Build `selectedEntries` map from the links
- All initially linked groups start expanded

**UI structure (styled to match existing admin form sections):**

```
<section> with white card styling matching OptionsAccordion (bg-white rounded-[12px] border border-[#e8eaef] p-[24px])
  <label> "ตัวเลือกสินค้า (Variations)" — section heading

  {/* Group selector dropdown */}
  <div> with search input + dropdown listing all groups NOT already linked
    - Input with placeholder "ค้นหากลุ่มตัวเลือก..." and search icon
    - Dropdown shows groups filtered by search, each clickable to ADD the group
    - Clicking a group adds its ID to linkedGroups, selects ALL its entries by default, expands it
    - Dropdown closes after selection
  </div>

  {/* Linked groups */}
  {linkedGroups.map(groupId => {
    const group = allGroups.find(g => g.id === groupId)
    return (
      <div> card for each linked group
        <div> header row with:
          - ChevronDown icon (rotated if collapsed)
          - Group name (bold)
          - Entry count badge: "3/5 เลือกแล้ว" (selected/total)
          - Unlink button (X icon) — removes group from linkedGroups and clears its selectedEntries
        </div>

        {expanded && (
          <div> entry list
            {group.variation_entries sorted by sort_order, each as:
              <label> checkbox row
                - Checkbox input (checked if entry is in selectedEntries[groupId])
                - Swatch image thumbnail (24x24, if entry.image_url exists)
                - Entry label text
              </label>
            }

            {/* Ad-hoc entry creation (LINK-05) */}
            <div> inline form for adding new entry on-the-fly
              - Text input with placeholder "เพิ่มตัวเลือกใหม่..."
              - "+" button to add
              - On add: call createVariationEntry server action (imported from variations.js) with group_id and label
              - On success: add the new entry to the group's entries in local state, auto-check it
              - Show toast on error
            </div>
          </div>
        )}
      </div>
    )
  })}
</section>
```

**onChange callback:**
- Call `onChange(links)` whenever `linkedGroups` or `selectedEntries` changes
- Build links array: for each groupId in linkedGroups, for each entryId in selectedEntries[groupId], push `{ group_id: groupId, entry_id: entryId }`

**Key behaviors:**
- When adding a group: all entries are pre-selected (checked) by default
- When unlinking a group: remove from linkedGroups, clear its selectedEntries — this implements LINK-03
- Checkbox toggles: toggling an entry checkbox updates selectedEntries and triggers onChange
- Ad-hoc entries: use `createVariationEntry` from `@/lib/actions/variations` to persist, then add to local group entries array and auto-select. Use `useTransition` for the pending state on the add button.
- The `allGroups` prop provides the full list including entries — the component does NOT fetch data itself

**Styling conventions:**
- All text in Thai
- Font: `font-['IBM_Plex_Sans_Thai']` matching other admin components
- Colors: orange for accents (`text-orange`, `bg-orange`), `border-[#e8eaef]`, `text-[#1f2937]`, `text-[#6b7280]`
- Checkboxes: `accent-orange` for orange check color
- Card sections: `bg-[#f9fafb]` for linked group cards, white for main section
- Entry count badge: small pill with `bg-orange/10 text-orange`
- Unlink button: subtle icon button with `hover:bg-red-50 hover:text-red-500`
- Search input: same input class pattern as OptionsAccordion

**Import `createVariationEntry` from `@/lib/actions/variations`** for ad-hoc entry creation.
**Import `useToast` from `@/lib/toast-context`** for error toasts.
**Import `useTransition` from 'react'** for async operations.
  </action>
  <verify>Run `npm run build` to verify the component compiles. Check that the file exports a default function component. Grep for `createVariationEntry` import to confirm ad-hoc wiring. Grep for `onChange` in the component to confirm callback integration.</verify>
  <done>VariationLinker.jsx exists as a reusable 'use client' component. It renders group search/select, entry checkboxes, unlink buttons, and ad-hoc entry creation. It calls onChange with current links array on every selection change. Build passes.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. `syncProductVariationLinks` is exported from products.js
3. `getProduct` includes `product_variation_links` in its select query
4. `VariationLinker.jsx` exists and exports a default component
5. VariationLinker imports `createVariationEntry` for ad-hoc entry creation
6. VariationLinker accepts `allGroups`, `initialLinks`, and `onChange` props
</verification>

<success_criteria>
- Server action can bulk-replace product-variation links
- getProduct returns variation link data with group/entry details
- VariationLinker component provides complete UI for selecting groups, picking entries, unlinking groups, and creating ad-hoc entries
- All code compiles and build passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-product-integration/07-01-SUMMARY.md`
</output>
