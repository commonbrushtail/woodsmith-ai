---
phase: 06-variation-admin-ui
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/app/(admin)/admin/variations/create/page.jsx
  - src/components/admin/VariationCreateClient.jsx
  - src/app/(admin)/admin/variations/edit/[id]/page.jsx
  - src/components/admin/VariationEditClient.jsx
autonomous: true

must_haves:
  truths:
    - "Admin can create a new variation group with a name and multiple entries"
    - "Admin can add entries with labels and optional swatch images during creation"
    - "Admin can navigate to edit page and modify an existing variation group name"
    - "Admin can add, edit, and delete entries on the edit page"
    - "Admin can upload swatch images for variation entries"
    - "Admin can drag-and-drop reorder entries within a group"
    - "Admin can delete a variation group from edit page with confirmation dialog"
  artifacts:
    - path: "src/app/(admin)/admin/variations/create/page.jsx"
      provides: "Server component for create route"
      exports: ["default"]
    - path: "src/components/admin/VariationCreateClient.jsx"
      provides: "Client form for creating variation groups with entries"
      exports: ["default"]
      min_lines: 100
    - path: "src/app/(admin)/admin/variations/edit/[id]/page.jsx"
      provides: "Server component for edit route fetching existing group"
      exports: ["default"]
    - path: "src/components/admin/VariationEditClient.jsx"
      provides: "Client form for editing variation groups with entries"
      exports: ["default"]
      min_lines: 150
  key_links:
    - from: "src/app/(admin)/admin/variations/create/page.jsx"
      to: "src/components/admin/VariationCreateClient.jsx"
      via: "import and render"
      pattern: "VariationCreateClient"
    - from: "src/app/(admin)/admin/variations/edit/[id]/page.jsx"
      to: "src/lib/actions/variations.js"
      via: "import getVariationGroup"
      pattern: "getVariationGroup"
    - from: "src/app/(admin)/admin/variations/edit/[id]/page.jsx"
      to: "src/components/admin/VariationEditClient.jsx"
      via: "import and render with group prop"
      pattern: "VariationEditClient"
    - from: "src/components/admin/VariationCreateClient.jsx"
      to: "src/lib/actions/variations.js"
      via: "import createVariationGroup, createVariationEntry, uploadVariationSwatchImage"
      pattern: "createVariationGroup|createVariationEntry"
    - from: "src/components/admin/VariationEditClient.jsx"
      to: "src/lib/actions/variations.js"
      via: "import updateVariationGroup, createVariationEntry, updateVariationEntry, deleteVariationEntry, deleteVariationGroup, reorderVariationEntries"
      pattern: "updateVariationGroup|deleteVariationGroup|reorderVariationEntries"
---

<objective>
Create the variation group create and edit pages with full form functionality including entry management, swatch image upload, drag-and-drop reorder, and group deletion.

Purpose: These are the core admin pages where variation groups are actually created and managed. Without these, the list page has nowhere to link to.
Output: Create page (server + client), Edit page (server + client) with complete CRUD functionality
</objective>

<execution_context>
@C:/Users/commo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/commo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-variation-admin-ui/06-01-SUMMARY.md
@src/lib/actions/variations.js
@src/lib/validations/variations.js
@src/components/admin/OptionsAccordion.jsx
@src/components/admin/ProductImageUploader.jsx
@src/app/(admin)/admin/products/create/ProductCreateClient.jsx
@src/app/(admin)/admin/products/edit/[id]/ProductEditClient.jsx
@src/app/(admin)/admin/products/edit/[id]/page.jsx
@src/app/(admin)/admin/products/create/page.jsx
@src/app/(admin)/admin/faq/edit/[id]/page.jsx
@src/lib/hooks/use-form-errors.js
@src/lib/toast-context.jsx
@src/lib/upload-validation.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create variation group create page</name>
  <files>
    src/app/(admin)/admin/variations/create/page.jsx
    src/components/admin/VariationCreateClient.jsx
  </files>
  <action>
**1. Create server component** at `src/app/(admin)/admin/variations/create/page.jsx`:

Simple server component — no data to pre-fetch (creating new group):
```jsx
import VariationCreateClient from '@/components/admin/VariationCreateClient'

export default function VariationCreatePage() {
  return <VariationCreateClient />
}
```

**2. Create VariationCreateClient.jsx** at `src/components/admin/VariationCreateClient.jsx`:

Follow the ProductCreateClient.jsx structure/style but MUCH simpler (only a group name + entries, no tabs/sidebar/rich text/dates). Use `'use client'` directive.

**Imports:**
- `useState, useTransition, useRef` from react
- `useRouter` from next/navigation
- `Link` from next/link
- `createVariationGroup, createVariationEntry, uploadVariationSwatchImage` from `@/lib/actions/variations`
- `useToast` from `@/lib/toast-context`
- `useFormErrors` from `@/lib/hooks/use-form-errors`
- `validateFile` from `@/lib/upload-validation`

**Layout — follow ProductCreateClient pattern (header + content + sidebar):**

**Header:**
- Back link: `<Link href="/admin/variations">` with ChevronLeftIcon + "กลับ" text (same style as ProductCreateClient)
- Title: `กลุ่มตัวเลือกใหม่ (New Variation Group)` — bold 22px
- No tabs, no locale picker (variations are simpler)

**Main content area (left side, flex-1):**

Section 1 — Group name:
- White card with `bg-white rounded-[12px] border border-[#e8eaef] p-[24px]`
- Label: `ชื่อกลุ่มตัวเลือก` with required asterisk
- Text input bound to `groupName` state, with error display via formErrors
- Use `inputCls` helper matching ProductCreateClient pattern

Section 2 — Entries:
- White card: `ตัวเลือก (Entries)`
- List of entries, each entry as a row with:
  - Swatch image upload button (48x48 dashed border square, click to upload, shows preview when image set, X button to remove on hover) — follow the `EntryImageUpload` pattern from OptionsAccordion.jsx exactly
  - Text input for label (placeholder: `กรอกชื่อตัวเลือก`)
  - Delete button (TrashIcon) to remove entry from local list
- "เพิ่มตัวเลือก" (Add entry) button at bottom with PlusIcon — orange text, same style as OptionsAccordion
- Entries stored in local state array: `[{ id, label, imageFile, imageUrl, previewUrl }]`
- Start with one empty entry by default
- Use `genId()` helper for temporary IDs (same as OptionsAccordion)

**Sidebar (right side, w-[260px]):**
- Sticky card with `bg-white rounded-[12px] border border-[#e8eaef] p-[20px]`
- Header: "Entry" (uppercase, small text)
- "บันทึก" (Save) button — orange bg, white text, full width
- Disabled state when isPending

**Submit flow (critical — two-phase create):**

1. Validate: group name required (show error if empty via formErrors)
2. Create group first: build FormData with `name` field, call `createVariationGroup(formData)`
3. If fieldErrors returned: show via formErrors and toast.error
4. If error: show toast.error
5. If success: get `result.data.id` (the new group ID)
6. For each entry that has a non-empty label:
   a. Build FormData with `group_id` = new group ID, `label` = entry label
   b. If entry has imageFile: add `file` to FormData
   c. Call `createVariationEntry(entryFormData)`
   d. If error on any entry: show toast.error but continue (partial success OK)
7. After all entries created: `router.push('/admin/variations')`

**Error handling:**
- Use `useFormErrors` hook for field-level errors on group name
- Use `useToast` for success/error notifications
- Wrap submit in `startTransition` for pending state

**Styling:**
- All text uses `font-['IBM_Plex_Sans_Thai']`
- Input classes match `inputCls` from ProductCreateClient
- Match the flex layout: `flex gap-[24px]` with main content `flex-1` and sidebar `w-[260px] shrink-0`
- Pending state: `opacity-60 pointer-events-none` on content area
  </action>
  <verify>
Run `npm run build` — must pass. Verify:
- `src/app/(admin)/admin/variations/create/page.jsx` exists
- `src/components/admin/VariationCreateClient.jsx` exists and imports createVariationGroup + createVariationEntry
  </verify>
  <done>
Admin can navigate to /admin/variations/create, enter a group name, add multiple entries with labels and optional swatch images, and save to create the group with all entries persisted to database.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create variation group edit page with delete and reorder</name>
  <files>
    src/app/(admin)/admin/variations/edit/[id]/page.jsx
    src/components/admin/VariationEditClient.jsx
  </files>
  <action>
**1. Create server component** at `src/app/(admin)/admin/variations/edit/[id]/page.jsx`:

Follow the exact pattern from `src/app/(admin)/admin/products/edit/[id]/page.jsx` and `src/app/(admin)/admin/faq/edit/[id]/page.jsx`:

```jsx
import { notFound } from 'next/navigation'
import { getVariationGroup } from '@/lib/actions/variations'
import VariationEditClient from './VariationEditClient'

export default async function VariationEditPage({ params }) {
  const { id } = await params
  const { data: group, error } = await getVariationGroup(id)

  if (error || !group) {
    notFound()
  }

  return <VariationEditClient group={group} />
}
```

**2. Create VariationEditClient.jsx** at `src/components/admin/VariationEditClient.jsx`:

Similar to VariationCreateClient but with existing data, entry CRUD operations, drag-and-drop reorder, and group deletion.

**Imports:**
- `useState, useTransition, useRef` from react
- `useRouter` from next/navigation
- `Link` from next/link
- `updateVariationGroup, createVariationEntry, updateVariationEntry, deleteVariationEntry, deleteVariationGroup, reorderVariationEntries, uploadVariationSwatchImage` from `@/lib/actions/variations`
- `useToast` from `@/lib/toast-context`
- `useFormErrors` from `@/lib/hooks/use-form-errors`
- `validateFile` from `@/lib/upload-validation`
- dnd-kit imports for drag-and-drop (same imports as FaqListClient):
  - `DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors` from `@dnd-kit/core`
  - `arrayMove, SortableContext, sortableKeyboardCoordinates, useSortable, verticalListSortingStrategy` from `@dnd-kit/sortable`
  - `CSS` from `@dnd-kit/utilities`

**State initialization from group prop:**
- `groupName`: `group.name`
- `entries`: map from `group.variation_entries` to local shape: `[{ id, label, imageUrl, imageFile, previewUrl, isNew: false }]` — sorted by sort_order already from server action
- `newEntries`: separate array for entries added during this edit session: `[{ id, label, imageFile, previewUrl, isNew: true }]`

Actually, simpler approach: use a single `entries` state array. Existing entries have `isExisting: true` and a real DB `id`. New entries have `isExisting: false` and a temp `id`.

```js
const [entries, setEntries] = useState(() =>
  (group.variation_entries || []).map(e => ({
    id: e.id,
    label: e.label,
    imageUrl: e.image_url,
    imageFile: null,
    previewUrl: null,
    isExisting: true,
  }))
)
```

**Layout — same header/content/sidebar pattern as create page:**

**Header:**
- Back link to `/admin/variations`
- Title: `แก้ไขกลุ่มตัวเลือก` — bold 22px

**Main content area:**

Section 1 — Group name:
- Same as create page but pre-filled with `group.name`

Section 2 — Entries with drag-and-drop:
- Wrap entry list in DndContext + SortableContext (follow FaqListClient pattern)
- Each entry row is a sortable item with:
  - Drag handle (GripIcon, 6-dot pattern) — same as FaqListClient's SortableRow
  - Swatch image upload (same EntryImageUpload pattern as create page)
  - Text input for label (pre-filled for existing entries)
  - Delete button (TrashIcon)
- Use `useSortable` hook on each entry row (follow SortableRow from FaqListClient)
- On drag end: reorder local state + call `reorderVariationEntries` server action with new sort_order values
- "เพิ่มตัวเลือก" (Add entry) button at bottom

**Sidebar:**
- "บันทึก" (Save) button — saves group name changes and entry modifications
- "ลบกลุ่มตัวเลือก" (Delete group) button — red text, secondary style, triggers delete flow

**Save flow (incremental updates, not batch replace):**

1. Validate group name (required)
2. If group name changed from original: call `updateVariationGroup(group.id, formData)` with new name
3. For each existing entry where label changed OR image changed:
   a. Build FormData with `label` if changed
   b. If new imageFile: add `file` to FormData
   c. If image was removed (imageUrl was set, now null): add `remove_image=true` to FormData
   d. Call `updateVariationEntry(entry.id, formData)`
4. For each new entry (isExisting === false) with non-empty label:
   a. Build FormData with `group_id` = group.id, `label`
   b. If imageFile: add `file`
   c. Call `createVariationEntry(formData)`
5. For deleted entries (tracked in a `deletedEntryIds` state array):
   a. Call `deleteVariationEntry(id)` for each
6. Show toast.success on completion, then `router.push('/admin/variations')`

Track deleted entries: when user clicks delete on an existing entry, add its ID to `deletedEntryIds` state array and remove from entries display array. Process actual deletes during save.

**Delete group flow:**
- On "ลบกลุ่มตัวเลือก" click: call `deleteVariationGroup(group.id)` without force
- If response has `warning: true`: show `confirm()` with message: `${result.message} ต้องการลบหรือไม่?`
- If user confirms: call `deleteVariationGroup(group.id, { force: true })`
- If error: toast.error
- If success: `router.push('/admin/variations')`

**Entry deletion (individual):**
- For existing entries: add to `deletedEntryIds` array, remove from display
- For new entries (not yet saved): just remove from local state
- Actual DB deletion happens when "บันทึก" is clicked (batched with other changes)

Alternative simpler approach for entry deletion: delete immediately when clicked (call `deleteVariationEntry(id)` right away for existing entries). This is simpler and follows the pattern of ProductImageUploader where deletes are immediate in edit mode. Use this approach:
- For existing entries: call `deleteVariationEntry(id)` immediately with confirmation, remove from local state on success
- For new entries: just remove from local state

**Drag-and-drop reorder:**
- On drag end: compute new sort_order for each entry, update local state, call `reorderVariationEntries(updates)` where updates = `[{ id, sort_order }]`
- Follow FaqListClient's `handleDragEnd` pattern with `arrayMove` and `buildSortOrderUpdates`
- Import `buildSortOrderUpdates` from `@/lib/reorder`
- Only reorder existing entries (new unsaved entries get sort_order assigned on save by the server action)

**Styling:**
- Match VariationCreateClient exactly (same header, input styles, card styles, sidebar)
- Drag handle: GripIcon (6-dot pattern) on the left of each entry row, `cursor-grab active:cursor-grabbing`
- Delete group button in sidebar: `text-[#ef4444]` text color, `border border-[#ef4444]/30` border, `hover:bg-[#fef2f2]` background
  </action>
  <verify>
Run `npm run build` — must pass. Verify:
- `src/app/(admin)/admin/variations/edit/[id]/page.jsx` exists and imports getVariationGroup
- `src/components/admin/VariationEditClient.jsx` exists and imports updateVariationGroup, deleteVariationGroup, reorderVariationEntries, createVariationEntry, updateVariationEntry, deleteVariationEntry
- VariationEditClient uses DndContext and SortableContext for drag-and-drop
  </verify>
  <done>
Admin can navigate to /admin/variations/edit/{id}, see existing group name and entries pre-filled, modify the group name, add/edit/delete entries with swatch images, drag-and-drop reorder entries, save all changes, and delete the entire group with confirmation for linked products.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes with no errors
- All four files exist and follow the server/client component pattern
- Create page successfully creates a group then entries in sequence
- Edit page loads existing group data and supports incremental updates
- Edit page has drag-and-drop entry reordering via dnd-kit
- Edit page has group deletion with force-delete confirmation flow
- All UI text is in Thai
- All styling matches existing admin page conventions
</verification>

<success_criteria>
1. Build passes
2. /admin/variations/create renders a form with group name and entry list
3. Submitting create form creates group + entries in database
4. /admin/variations/edit/{id} renders pre-filled form with existing data
5. Entry swatch images can be uploaded and previewed
6. Entries can be drag-and-drop reordered
7. Entries can be added and deleted
8. Group name can be updated
9. Group can be deleted with confirmation for linked products
10. All forms navigate back to /admin/variations on success
</success_criteria>

<output>
After completion, create `.planning/phases/06-variation-admin-ui/06-02-SUMMARY.md`
</output>
